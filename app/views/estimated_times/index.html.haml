.contextual
  = link_to "неделей раньше", {:current_date => @current_date - 1.week}.merge(params)
  = " | "
  - form_tag({}, :method => :get) do
    = hidden_field_tag :current_user_id, @current_user.id
    - exclude_filters.each do |key|  
      - if params[:"exclude_#{key}"].present?
        = hidden_field_tag :"exclude_#{key}", params[:"exclude_#{key}"]    
    - if @project.present?
      = hidden_field_tag :project_id, @project.identifier
    %select{:id => :current_date, :name => :current_date, :class => "small", :onchange => "this.form.submit(); return false;"}
      %option
      - @current_dates.each do |cur_date|        
        - if @current_date == cur_date
          %option{:value => cur_date, :selected => "selected"}
            = format_date(cur_date)
        - else
          %option{:value => cur_date}
            = format_date(cur_date)
  = " | "  
  = link_to "неделей позже", {:current_date => @current_date + 1.week}.merge(params)

%h2=l(:label_estimated_time_plural)

%fieldset
  %legend= l(:label_filter_plural)
  - form_tag({}, :method => :get) do
    = hidden_field_tag :current_date, @current_date
    - exclude_filters.each do |key|  
      - if params[:"exclude_#{key}"].present?
        = hidden_field_tag :"exclude_#{key}", params[:"exclude_#{key}"]    
    - if @planning_manager.workers.any?
      %label{:for=>'current_user_id'}= l(:field_user) + ":"
      %select{:id => 'current_user_id', :name => 'current_user_id', :class => "small", :onchange => "this.form.submit(); return false;"}
        - ([User.current] + @planning_manager.workers).each do |user|
          - if @current_user.id == user.id
            %option{:value => user.id, :selected => "selected"}
              = user.name
          - else
            %option{:value => user.id}
              = user.name
              
  - form_tag({}, :method => :get) do
    = hidden_field_tag :current_date, @current_date
    = hidden_field_tag :current_user_id, @current_user.id
    - exclude_filters.each do |key|  
      - if params[:"exclude_#{key}"].present?
        = hidden_field_tag :"exclude_#{key}", params[:"exclude_#{key}"]      
    %label{:for=>'project_id'}= l(:field_project) + ":"
    %select{:id => 'project_id', :name => 'project_id', :class => "small", :onchange => "this.form.submit(); return false;"}
      %option
        = l(:label_project_all)
      - @assigned_projects.each do |project|
        - if params[:project_id] == project.identifier
          %option{:value => project.identifier, :selected => "selected"}
            = project.name
        - else
          %option{:value => project.identifier}
            = project.name
  - if @project.present?
    = link_to l(:label_issue_new), {:controller => :issues, :project_id => @project.identifier, :action => :new}, :class => 'icon icon-add'
    
  %br
  
  - exclude_filters.each do |key|  
    - if params[:"exclude_#{key}"].present?
      = link_to l(:"label_include_#{key}"), params.merge( :"exclude_#{key}" => nil)
    - else
      = link_to l(:"label_exclude_#{key}"), params.merge( :"exclude_#{key}" => 1)
    = " / " unless key == exclude_filters.last

%table.list
  %thead
    %tr
      %th{:rowspan => 2}="#"
      %th{:rowspan => 2}= l(:field_subject)
      %th{:rowspan => 2}= l(:field_deadline)      
      %th{:colspan => 2}= (@current_date).strftime("%d.%m")
      %th{:colspan => 2}= (@current_date + 1.day).strftime("%d.%m")
      %th{:colspan => 2}= (@current_date + 2.days).strftime("%d.%m")
      %th{:colspan => 2}= (@current_date + 3.days).strftime("%d.%m")
      %th{:colspan => 2}= (@current_date + 4.days).strftime("%d.%m")
      %th{:colspan => 2}= (@current_date + 5.days).strftime("%d.%m")
      %th{:colspan => 2}= (@current_date + 6.days).strftime("%d.%m")
      %th{:colspan => 2}= l(:label_total)
    %tr
      - 8.times do
        %th= l(:label_plan)
        %th= l(:label_spent)
  %tbody
    - @assigned_issues.each do |issue|
      %tr.even{:class => issue.css_classes}
        %td.id
          = link_to issue.id, issue_path(issue), :title => issue.subject
        %td.subject
          = link_to issue.subject, issue_path(issue), :title => issue.project
          = "(#{issue.status})"
        %td.deadline{:align => :center}
          = issue_dates(issue)
        - 7.times do |day|
          - if day >= 5
            %td{:align=>:center, :class => "odd"}
              = link_to_plan(issue, day)
            %td{:align=>:center, :class => "odd"}
              = link_to_spent(issue, day)            
          - else
            %td{:align=>:center}
              = link_to_plan(issue, day)
            %td{:align=>:center}
              = link_to_spent(issue, day)
        %td{:align=>:center}
          - if estimated_time_sum = @estimated_time_sum[issue.id]
            = estimated_time_sum.map(&:hours).sum(0.0)
        %td
          - if User.current == @current_user
            = link_to issue.total_spent_hours, {:controller => 'timelog', :action => 'index', :project_id => issue.project, :issue_id => issue, :period_type => 1}
          - else
            = issue.total_spent_hours
    %tfoot
      %tr
        %th{:colspan => 3}
          = l(:label_total)        
        - 7.times do |day|
          %th
            - sum = sum_hours_plan_on(day)
            %span{:style => style_for_sum(sum)}
              = sum
          %th
            - sum = sum_hours_spent_on(day)
            %span{:style => style_for_sum(sum)}
              = sum
        %th
        %th         

%fieldset
  %legend= l(:label_issue_new)
  - form_tag({:controller => :issues, :action => :new}, :method => :get) do
    %select{:id => 'project_id', :name => 'project_id', :class => "small", :onchange => "this.form.submit(); return false;"}
      %option{:selected => "selected"}
        = l(:label_select_project_for_new_issue)
      - @assigned_projects.each do |project|
        %option{:value => project.identifier}
          = project.name

      
- if (User.current == @current_user)&&(@assigned_issues.any?)
  %h2= l(:label_plan_time)
  - labelled_form_for @estimated_time do |f|
    = render :partial => 'form', :locals => {:f => f}
    = submit_tag l(:button_save), :disabled => false
            
- html_title(l(:label_estimated_time_plural))
